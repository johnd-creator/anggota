# Security Development Notes

## 2025-12-23 23:00
- Date: 2025-12-23 23:00
- Scope: security
- Summary:
  - B5: Export/Import/API anti-IDOR complete
  - Prevented unit_id injection attacks for non-global users
  - API endpoints now validate unit_id
- Protected Endpoints:
  - POST /reports/{type}/export - Gate + forced unit scope
  - GET /admin/members-export - Gate + forced unit scope
  - GET /admin/mutations/export - Gate + forced unit scope
  - GET /api/members - requires unit_id (400 if missing)
  - GET /api/mutations - requires unit_id (400 if missing)
  - GET /api/documents - requires unit_id (400 if missing)
- ExportScopeHelper:
  - Non-global users: ignores requested unit_id, uses currentUnitId()
  - Global users: can filter by any unit
- PII Reduction:
  - /api/members: removed email, phone
  - /api/documents: removed path
  - reports/documents: removed email from export
- Tests (ExportUnitScopeTest):
  - admin_unit export with other unit_id → still scoped to own unit
  - API without unit_id → 400
  - API with unit_id → scoped response

## 2025-12-23 22:45
- B4: Finance anti-IDOR

## 2025-12-23 22:35
- B3: Letter anti-IDOR

## 2025-12-23 22:15
- B2: Member/Mutation unit scope

## 2025-12-23 23:10
- Date: 2025-12-23 23:10
- Scope: security
- Summary:
  - B6: Reports UI & Token API Hardening
  - UI Reports (Growth, Mutations, Documents) protected from query param IDOR
  - API Reports: Require unit_id, throttle:60,1, PII stripped
- Protected Endpoints:
  - GET /reports/growth|mutations|documents
  - GET /api/reports/growth|mutations|documents
- UX Hardening:
  - Admin Unit Create Member: form only shows own unit
  - Admin Unit Store Member: backend forces currentUnitId()
- Tests:
  - ReportUnitScopeTest: verifies UI Inertia props are scoped
  - ApiReportsScopeTest: verifies 400 on missing unit_id & scoped data

## 2025-12-24 10:11
- Date: 2025-12-24 10:11
- Scope: security
- Summary:
  - Point B gap fix: standardized admin member unit scope to `currentUnitId()` to avoid IDOR via missing `organization_unit_id`.
  - Prevented member aspirations index crash for non-member users (stability hardening).
- Files:
  - app/Http/Controllers/Admin/MemberController.php
  - app/Http/Controllers/Member/AspirationController.php
  - tests/Feature/MemberAspirationsIndexTest.php
- Commands: none
- Decisions/Risks:
  - Authorization relies on `Gate::authorize` + policies for cross-unit 403; manual duplicate 403 checks removed in Member admin controller.
- Next:
  - Re-run security regression tests (RBAC/unit scope) before release tag.

## 2025-12-24 10:16
- Date: 2025-12-24 10:16
- Scope: security
- Summary:
  - Fixed runtime 500 in member aspirations index by adding missing `Aspiration::user()` relationship (prevents accidental information disclosure via error pages).
- Files:
  - app/Models/Aspiration.php
- Commands:
  - php artisan test --filter MemberAspirationsIndexTest
  - php artisan test --filter RbacUnitScopeRegressionTest
- Decisions/Risks: none
- Next: none

- Date: 2026-01-07 19:21
- Scope: security
- Summary:
  - Sanitizer now normalizes whitespace in text nodes to reduce rendering gaps without allowing unsafe HTML.
- Files:
  - app/Services/HtmlSanitizerService.php
- Commands: none
- Decisions/Risks:
  - Multiple spaces are collapsed; users should use <br> or new paragraphs for spacing.
- Next: none

- Date: 2026-01-07 10:23
- Scope: security
- Summary:
  - Service worker no longer caches stale `/build/manifest.json`, reducing risk of clients running outdated frontend bundles after deploy.
- Files:
  - public/service-worker.js
- Commands: none
- Decisions/Risks:
  - None.
- Next: none

- Date: 2026-01-05 10:15
- Scope: security
- Summary:
  - Settings backend endpoints now exist for profile update and session management (`/settings/profile`, `/settings/sessions`, `/settings/sessions/revoke-others`).
  - Notifications preferences validation expanded to include new categories (announcements, dues, reports, finance).
- Files:
  - routes/web.php
  - app/Services/NotificationService.php
- Decisions/Risks:
  - UI hides privacy actions for non-members; backend still enforces role checks.
- Next: none

- Date: 2026-01-04 21:14
- Scope: security
- Summary:
  - Added explicit guard to prevent using announcement dismissal endpoint before DB migrations are applied (returns 503).
- Files:
  - app/Http/Controllers/AnnouncementController.php
- Commands: none
- Decisions/Risks:
  - Ensures predictable behavior in fresh environments (instead of SQL exceptions).
- Next: none

- Date: 2026-01-04 21:05
- Scope: security
- Summary:
  - Added per-user dismissal endpoint for pinned announcements; authorization uses `AnnouncementPolicy@view` (only visible announcements can be dismissed).
- Files:
  - app/Http/Controllers/AnnouncementController.php
  - routes/web.php
- Commands: none
- Decisions/Risks:
  - Dismissal records are user-scoped; no cross-user impact.
- Next: none

- Date: 2026-01-03 05:47
- Scope: security
- Summary:
  - Removed stale forum migrations that could cause unexpected migration failures and block test execution.
- Files:
  - database/migrations/*forum*.php (deleted leftovers)
- Commands:
  - php artisan migrate:fresh --seed
- Decisions/Risks:
  - Keeping migrations aligned with installed packages reduces operational risk during incident response.
- Next: none

- Date: 2025-12-31 15:40
- Scope: security
- Summary:
  - Hardened announcements scope enforcement by applying admin_unit overrides before validation and scoping checks via `currentUnitId()` (prevents tampering + unit mismatch edge cases).
- Files:
  - app/Http/Requests/Admin/AnnouncementRequest.php
  - app/Policies/AnnouncementPolicy.php
  - app/Models/Announcement.php
- Commands: none
- Decisions/Risks:
  - `unit` announcements now require a resolvable unit ID; accounts without unit linkage will be blocked until fixed.
- Next: none

- Date: 2025-12-24 19:24
- Scope: security
- Summary:
  - Point D: Ensured export audit events are written even if the response stream is not consumed (prevents missing compliance evidence).
  - Set import audit `event_category` to `export` so retention/purge policy applies consistently.
- Files:
  - routes/web.php
  - app/Http/Controllers/Admin/MemberImportController.php
- Commands: see `development-notes/testing.md`
- Decisions/Risks:
  - Export audit logs may be recorded even if a client cancels the download mid-stream; row counts reflect the pre-stream query.
- Next: none

## 2025-12-24 10:17
- Date: 2025-12-24 10:17
- Scope: security
- Summary:
  - Backfill: B7–B9 hardening completed (scoped dashboard metrics, scoped member search, restricted admin activity logs and aspiration categories).
  - Added regression tests to detect cross-unit data exposure and unauthorized admin access.
- Files:
  - app/Http/Middleware/HandleInertiaRequests.php
  - app/Http/Controllers/DashboardController.php
  - app/Http/Controllers/LetterController.php
  - routes/web.php
  - tests/Feature/RbacUnitScopeRegressionTest.php
- Commands: none
- Decisions/Risks:
  - Token-based APIs remain shared-secret; scoping mitigates over-fetch but is not a per-unit auth boundary.
- Next: none

- Date: 2025-12-24 14:30
- Scope: security
- Summary:
  - Restricted letter approver management to global roles and enforced safe template rendering context (no PII).
  - Added validation/limits for template fields and default opt-out behavior for `channels.letters`.
- Files:
  - app/Http/Controllers/LetterController.php
  - app/Services/LetterTemplateRenderer.php
  - app/Models/NotificationPreference.php
  - app/Http/Controllers/Admin/LetterApproverController.php
  - routes/web.php
- Commands: none
- Decisions/Risks:
  - Unknown placeholders render as empty string; admin UX should guide supported placeholders.
- Next:
  - Re-check template placeholder list if new context fields are introduced.

- Date: 2025-12-24 17:40
- Scope: security
- Summary:
  - Point D: Fixed cross-unit IDOR in member import by scoping existing-member lookup to `organization_unit_id`.
  - Enforced global import rule: `organization_unit_id` is required per row when batch unit is null.
- Files:
  - app/Services/MemberImportService.php
  - tests/Feature/MemberImportIdorTest.php
- Commands: see `development-notes/testing.md`
- Decisions/Risks:
  - Batch types: scoped batches ignore row unit; global batches require row unit.
- Next: none

- Date: 2025-12-30 20:30
- Scope: security
- Summary:
  - Forum Integration: Created `ForumCategoryPolicy` for role-based forum category access.
  - "Pengumuman Pengurus" category restricted to non-anggota roles only.
  - Announcement thread creation limited to admin roles (super_admin, admin_pusat, admin_unit).
  - Registered policy in `AuthServiceProvider` for `TeamTeaTime\Forum\Models\Category`.
- Files:
  - app/Policies/ForumCategoryPolicy.php (NEW)
  - app/Providers/AuthServiceProvider.php
- Commands: none
- Decisions/Risks:
  - Forum package has its own internal authorization; custom policy adds role-based layer on top.
  - `is_private` flag on category works with policy for double protection.
- Next:
  - Verify policy enforcement after Livewire is installed and forum is functional.

- Date: 2025-12-31 13:20
- Scope: security
- Summary:
  - Announcements Authorization:
    - `view`: Strict enforcement of scope (global_all, global_officers, unit).
    - `create`: `admin_unit` forced to use their assigned `organization_unit_id`.
    - `download`: Attachments are private; download checks parent announcement visibility.
- Decisions:
  - Non-active announcements only visible to creator or admins.
  - Role-based route groups in `web.php` act as first layer; Policy is the robust second layer.

- Date: 2025-12-31 13:45
- Scope: enforcement
- Summary:
  - `AnnouncementRequest` implements `passedValidation` hook to force overrides:
    - `admin_unit` attempting to set 'global' scope is forced to 'unit'.
    - `admin_unit` attempting to use another unit's ID is forced to their own.
  - Controller Policy check `viewAny` ensures `admin_unit` only sees their own announcements.

- Date: 2025-12-31 14:05
- Scope: storage security
- Summary:
  - Attachments stored in `local` disk (not public).
  - Download route checks `download` policy (which delegates to announcement view).
  - Upload/Delete checks `update` policy (only authorized admins).
  - File path generated by server (UUID), no user input in path.

- Date: 2025-12-31 14:15
- Scope: visibility
- Summary:
  - Enforced `visibleTo($user)` on both Dashboard widget and Public List.
  - Inactive announcements are hidden by default in these views.
  - Pinned announcements respect scope (Unit A doesn't see Unit B's pinned).

- Date: 2026-01-03 05:30
- Scope: security
- Summary:
  - Implemented Feature Toggle as maintenance guard to reduce risk during incidents.
  - When feature is disabled, routes return 503 (no redirect loop, no information leak).
  - Middleware checks config flag before proceeding; fail-safe for unknown features.
- Protected Endpoints:
  - GET /announcements/* (public list/show/download)
  - GET|POST|PUT|DELETE /admin/announcements/* (admin management)
- Files:
  - app/Http/Middleware/EnsureFeatureEnabled.php
  - routes/web.php
- Decisions/Risks:
  - Response is plain text 503; Inertia pages will show generic error.
  - Unknown feature names allow by default to prevent typos from breaking app.
- Next: none

- Date: 2026-01-03 05:58
- Scope: security
- Summary:
  - Changed global_officers definition from role-based to union_position-based.
  - BEFORE: role != anggota could see global_officers announcements.
  - AFTER: union_position.name != Anggota (case-insensitive) can see global_officers.
  - Super admin and admin_pusat always have access for operational/verification.
- Impact:
  - Users with role bendahara/admin_unit but position Anggota will NO LONGER see global_officers.
  - Users with role anggota but position Ketua/Sekretaris WILL see global_officers.
- Files:
  - app/Models/User.php (isOfficer method)
  - app/Policies/AnnouncementPolicy.php
  - app/Models/Announcement.php
- Decisions/Risks:
  - This aligns visibility with organizational hierarchy, not system role.
  - Ensure union_position is set correctly for all members who should see officer announcements.
- Next: none

- Date: 2026-01-03 20:18
- Scope: security
- Summary:
  - Dues Module Access Control Hardening:
    - Bendahara can only update dues for members in their unit.
    - Admin Unit is RESTRICTED to view-only (cannot update dues).
    - Member can only view their own dues via `/member/dues`.
    - Cross-unit update attempts return 403 (even if UI allowed).
  - Audit logging for all dues modifications.
- Protected Endpoints:
  - POST /finance/dues/update - authorize('updateForMember')
  - POST /finance/dues/mass-update - validate unit scope + authorize
- Risks Mitigated:
  - Cross-unit dues modification via direct POST
  - Missing audit trail for financial changes
- Files:
  - app/Policies/DuesPaymentPolicy.php
  - app/Http/Controllers/Finance/FinanceDuesController.php
- Tests:
  - DuesAuthorizationTest: 6 cases covering cross-unit denial + audit
- Next: none
- Date: 2026-01-04 11:49
- Scope: security
- Summary:
  - Updated CSP img-src to allow Google profile images (`https://*.googleusercontent.com`) alongside ui-avatars.
- Files:
  - app/Http/Middleware/SecurityHeadersMiddleware.php
- Commands: none
- Decisions/Risks:
  - Allows external avatar images; still restricted to specific domain wildcard.
- Next: none

- Date: 2026-01-04 19:20
- Scope: security
- Summary:
  - Role-Aware Global Search Security:
    - SearchService enforces strict visibility scopes:
      - Members: Only sees own aspirations, inbox letters, visible announcements.
      - Admin Unit: Only sees members/aspirations/letters within their own unit.
      - Super Admin: Global access.
    - API Throttling: `throttle:30,1` applied to search API to prevent abuse.
    - Validation: Query string requires min 2 characters.
- Files:
  - app/Services/SearchService.php
  - tests/Feature/SearchApiTest.php
- Decisions/Risks:
  - Search results snippet generation strips tags to prevent XSS.
  - No PII (email/phone) returned in search results meta data.
- Next: none


## Search Hardening (2026-01-04)
- **Scope Enforcement**:
  - `SearchService` strictly enforces `organization_unit_id` match for Admin Unit.
  - Anggota restricted to own data (letters/aspirations) and cannot search Member model.
- **PII Protection**:
  - Emails in search results masked (`f***@domain.com`) for non-super-admin queries where applicable.
  - Member search currently restricted to Admin levels.
- **Audit Logging**:
  - Event `search.api` / `search.page` logged for Super Admin / Admin Pusat.
  - Query content is HASHED (`sha256`), not stored in plain text, to prevent PII leakage in logs.
- **Rate Limiting**:
  - `/api/search`: 15req/min (IP-based).

- Date: 2026-01-04 20:32
- Scope: security
- Summary:
  - Fixed privileged search audit payloads to store only hashed query metadata (whitelisted `query_hash`, `query_len`, `type_scope`, `role`).
  - Added `UserPolicy` and enforced admin user detail access with unit scoping for `admin_unit`.
  - Hardened role access checks in search code using null-safe role reads.
- Files:
  - config/audit.php
  - app/Policies/UserPolicy.php
  - app/Providers/AuthServiceProvider.php
  - app/Http/Controllers/Admin/UserController.php
  - app/Http/Controllers/SearchController.php
  - app/Services/SearchService.php
- Commands: none
- Decisions/Risks:
  - `search.*` logs remain category `system`; ensure retention aligns with policy if volume increases.
- Next: none

- Date: 2026-01-05 04:30
- Scope: security
- Summary:
  - Reports CSV Export Foundation Security Measures:
    - Scope enforcement via `ExportScopeHelper::getEffectiveUnitId()` - non-global users cannot inject `unit_id`.
    - PII masking via `ExportScopeHelper::shouldMaskPii()` for non-global users.
    - Audit logging for all export attempts (including 501 unimplemented types).
    - Rate limiting: `throttle:10,1` on export endpoint.
    - Feature flag: `FEATURE_REPORTS=false` returns 503 (maintenance mode).
    - Role restriction: Only `super_admin`, `admin_pusat`, `admin_unit`, `bendahara` can access exports.
- Protected Endpoints:
  - GET /reports/export - new unified export with scope enforcement
- Files:
  - app/Http/Controllers/ReportsExportController.php
  - app/Services/ExportScopeHelper.php
  - routes/web.php
- Decisions/Risks:
  - Audit payload excludes `q` parameter (potential PII in search terms).
  - `anggota` role explicitly denied export access via role middleware.
- Next: none

- Date: 2026-01-05 04:50
- Scope: security
- Summary:
  - R2: Enhanced reports export security measures.
  - Search query protection: `q` parameter stored as `q_len` + `q_hash` (SHA256) in audit, not raw value.
  - Aspirations export: Body content HTML-stripped and truncated to 200 chars (no injection risk in CSV).
  - PII masking: Non-global users (admin_unit, bendahara) get masked email/phone/nip in exports.
  - Authorization: Added `AspirationPolicy::export()` for proper Gate checks.
- Protected Endpoints:
  - GET /reports/export?type=members - enhanced with search filters
  - GET /reports/export?type=aspirations - new endpoint
- Files:
  - app/Http/Controllers/ReportsExportController.php
  - app/Policies/AspirationPolicy.php
- Decisions/Risks:
  - Search query hashing prevents PII leakage in audit logs while maintaining debug ability via hash matching.
  - Aspirations body snippet prevents large text fields in CSV output.
- Next: none

- Date: 2026-01-05 05:25
- Scope: security
- Summary:
  - R3: Secured Finance & Dues exports.
  - Feature Flag: All finance exports blocked (503) if `features.finance` is disabled.
  - Authorization: `DuesPayment` and `FinanceLedger` policies enforced (viewAny).
  - Scope: Non-global users can ONLY export their own unit data. Unit ID injection attacks prevented using `ExportScopeHelper`.
  - Audit: All exports logged with `export.reports.*` events. Dues notes masked/excluded unless explicitly requested.
- Protected Endpoints:
  - GET /reports/export?type=dues_*
  - GET /reports/export?type=finance_*
- Files:
  - app/Http/Controllers/ReportsExportController.php
- Decisions/Risks:
  - `dues_per_period` allows exporting notes which may contain sensitive info; ensure `include_notes` is used responsibly (audited).
- Next: none

- Date: 2026-01-05 09:42
- Scope: security
- Summary:
  - Settings Privacy Controls Hardening:
    - Request Data Export / Delete buttons now conditionally rendered based on member status ( or role ).
    - Prevents 403 errors for admin_unit/bendahara who might not have member privileges.
- Files:
  - resources/js/Pages/Settings/Index.vue
- Decisions/Risks:
  - Access control is UI-layer only here; backend policies already enforce the actual permission.
- Next: none

- Date: 2026-01-05 10:32
- Scope: security
- Summary:
  - Password reset in Settings now validates current password and logs out other devices on success.
- Files:
  - routes/web.php
  - resources/js/Pages/Settings/Index.vue
- Decisions/Risks:
  - Uses user-supplied current password; failed attempts return 422 with generic message.
- Next: none

- Date: 2026-01-05 11:28
- Scope: security
- Summary:
  - Settings password update now includes CSRF protection via shared Inertia token.
- Files:
  - app/Http/Middleware/HandleInertiaRequests.php
  - resources/js/Pages/Settings/Index.vue
- Decisions/Risks:
  - None.
- Next: none

- Date: 2026-01-07 09:34
- Scope: security
- Summary:
  - TE2: HTML Sanitization for Letter Body (Anti-XSS Protection).
  - Created `HtmlSanitizerService` using DOMDocument for server-side sanitization.
  - Whitelist approach: Only allowed tags and attributes preserved.
  - STRIPPED content:
    - `<script>`, `<iframe>`, `<object>`, `<embed>`, `<form>`, `<style>`, `<svg>`, etc.
    - `javascript:`, `data:`, `vbscript:`, `file:` URL schemes.
    - Event handlers: `onclick`, `onerror`, `onmouseover`, etc.
    - Dangerous style properties (only text-align allowed).
  - PRESERVED content:
    - Safe formatting tags: p, strong, em, u, ul, ol, li, h2, h3, a, span, etc.
    - Safe hrefs: http://, https://, mailto:
    - Text alignment styles: text-align: left|center|right|justify.
  - All anchor tags forced to target="_blank" rel="noopener noreferrer nofollow".
- Protected Endpoints:
  - POST /letters - body sanitized before save
  - PUT /letters/{id} - body sanitized before save
- Files:
  - app/Services/HtmlSanitizerService.php
  - app/Http/Controllers/LetterController.php
- Tests:
  - HtmlSanitizerServiceTest: 15 test cases covering XSS prevention.
- Decisions/Risks:
  - No composer packages used (pure PHP DOMDocument).
  - Backward compatible: plain text is auto-converted to safe HTML.
- Next: none

- Date: 2026-01-07 09:40
- Scope: security
- Summary:
  - TE3: Secure HTML Rendering in Letter Views.
  - All HTML is sanitized via `HtmlSanitizerService` before being passed to views.
  - Show, Preview use `v-html` with server-sanitized `bodyHtml` prop.
  - PDF uses `{!! $bodyHtml !!}` with pre-sanitized content.
  - No raw user HTML ever reaches template without sanitization.
- Files:
  - app/Http/Controllers/LetterController.php
  - resources/js/Pages/Letters/Show.vue
  - resources/js/Pages/Letters/Preview.vue
  - resources/views/letters/pdf.blade.php
- Decisions/Risks:
  - XSS prevention via server-side HtmlSanitizerService (TE2).
  - Frontend only displays pre-sanitized HTML.
- Next: none
- Date: 2026-01-08 10:44
- Scope: security
- Summary:
  - Mutation Cancel Authorization:
    - `cancel()` policy added to `MutationRequestPolicy`.
    - Super admin / admin_pusat: can cancel any pending mutation.
    - Admin unit: can only cancel mutations involving their unit (from_unit or to_unit).
    - Status check: Only pending mutations can be cancelled (policy returns false for approved/rejected).
  - Duplicate Prevention:
    - Backend guard in `store()` blocks creating new mutation when pending exists for same member.
    - Error message returned via flash (no data leakage).
- Protected Endpoints:
  - POST /admin/mutations - duplicate guard before create
  - POST /admin/mutations/{mutation}/cancel - policy authorization
- Files:
  - app/Http/Controllers/Admin/MutationController.php
  - app/Policies/MutationRequestPolicy.php
- Decisions/Risks:
  - Policy-based authorization ensures consistent enforcement.
  - No race condition DB lock; acceptable for low-volume mutation workflow.
- Next: none

