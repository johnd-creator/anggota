# Backend Development Notes

## 2025-12-23 23:00
- Date: 2025-12-23 23:00
- Scope: backend
- Summary:
  - B5: Export/Import/API hardening complete
  - Created ExportScopeHelper for unified scope enforcement
  - API endpoints require unit_id parameter
- Files:
  - app/Services/ExportScopeHelper.php (NEW)
  - routes/api.php - require unit_id, return 400 if missing
  - routes/web.php - reports.export, members.export, mutations.export
  - tests/Feature/ExportUnitScopeTest.php (NEW) - 8 tests
- Commands:
  - php artisan test --filter ExportUnitScope (8 tests pass)
- Decisions:
  - Non-global users forced to own unit (ignores unit_id param)
  - API /members removed email/phone from response
  - API /documents removed path from response
  - All exports use Gate::authorize()

## 2025-12-23 22:45
- B4: Finance security hardening

## 2025-12-23 22:35
- B3: Letter security hardening

## 2025-12-23 22:15
- B2: RBAC hardening with currentUnitId()

## 2025-12-23 23:10
- Date: 2025-12-23 23:10
- Scope: backend
- Summary:
  - B6: Reports and API unit scoping complete
  - ReportController: UI methods enforced unit scope via ExportScopeHelper
  - ReportController: API methods require unit_id (400) and strict scope
  - MemberController: create/store logic hardened for admin_unit
- Files:
  - app/Http/Controllers/ReportController.php
  - app/Http/Controllers/Admin/MemberController.php
  - routes/web.php (API throttle)
  - tests/Feature/ReportUnitScopeTest.php (NEW)
  - tests/Feature/ApiReportsScopeTest.php (NEW)
- Commands:
  - php artisan test --filter ReportUnitScopeTest
  - php artisan test --filter ApiReportsScopeTest
- Decisions:
  - UI Reports: non-global user filters.unit_id overwritten by valid unit
  - API: throttle:60,1 added to public token reports
  - API Documents: Removed email, phone, documents path from response

## 2025-12-24 10:11
- Date: 2025-12-24 10:11
- Scope: backend
- Summary:
  - B10: Gap fix for Point B (consistency + stability).
  - Admin Member module now scopes by `currentUnitId()` and no longer relies on `organization_unit_id` directly.
  - Member aspirations index no longer crashes for users without member profile.
- Files:
  - app/Http/Controllers/Admin/MemberController.php
  - app/Http/Controllers/Member/AspirationController.php
  - tests/Feature/MemberAspirationsIndexTest.php (NEW)
- Commands: none
- Decisions/Risks:
  - Removed redundant manual 403 checks in `Admin/MemberController` and rely on policies (`Gate::authorize`) for unit enforcement.
- Next:
  - Run targeted tests (MemberAspirationsIndexTest + regression suite) before tagging a checkpoint.

## 2025-12-24 10:16
- Date: 2025-12-24 10:16
- Scope: backend
- Summary:
  - Fixed missing `Aspiration::user()` relationship required by member aspirations index eager loading.
  - Verified regression tests pass for RBAC/unit scope + member aspirations.
- Files:
  - app/Models/Aspiration.php
- Commands:
  - php artisan test --filter MemberAspirationsIndexTest
  - php artisan test --filter RbacUnitScopeRegressionTest
- Decisions/Risks: none
- Next: none

- Date: 2026-01-07 19:21
- Scope: backend
- Summary:
  - Normalized whitespace in sanitized letter body to avoid large gaps/overflow in preview.
- Files:
  - app/Services/HtmlSanitizerService.php
- Commands: none
- Decisions/Risks:
  - Collapses repeated whitespace into single spaces; rely on <br>/<p> for explicit line breaks.
- Next: none

- Date: 2026-01-05 10:15
- Scope: backend
- Summary:
  - ReportController now supplies unit list for Growth/Mutations filters.
  - Mutations report includes total count and unit name mapping for top destinations.
- Files:
  - app/Http/Controllers/ReportController.php
- Commands: none
- Decisions/Risks:
  - Mutations distribution limited to top 10 destinations (unchanged).
- Next: none

- Date: 2026-01-04 21:14
- Scope: backend
- Summary:
  - Fixed dashboard crash when `announcement_dismissals` table is missing by adding `Schema::hasTable` guards.
  - Applied migration to create `announcement_dismissals` table.
- Files:
  - app/Http/Controllers/DashboardController.php
  - app/Http/Controllers/AnnouncementController.php
- Commands:
  - php artisan migrate
- Decisions/Risks:
  - `POST /announcements/{id}/dismiss` returns 503 until migrations are applied (guarded explicitly).
- Next: none

- Date: 2026-01-04 21:05
- Scope: backend
- Summary:
  - Added per-user dismissal for pinned dashboard announcements (stored in DB).
  - Dashboard pinned announcements query now excludes dismissed items for the current user.
- Files:
  - app/Http/Controllers/AnnouncementController.php
  - app/Http/Controllers/DashboardController.php
  - app/Models/Announcement.php
  - app/Models/AnnouncementDismissal.php
  - app/Models/User.php
  - database/migrations/2026_01_04_205000_create_announcement_dismissals_table.php
  - routes/web.php
- Commands:
  - php artisan test --filter AnnouncementDismissalTest
- Decisions/Risks:
  - Dismissal is per-user (does not affect global pin state).
- Next: none
## 2025-12-24 10:17
- Date: 2025-12-24 10:17
- Scope: backend
- Summary:
  - Backfill: B7–B9 executed (dashboard counters/alerts scoped, member search scoped, admin logs + global config locked down).
  - Added regression coverage for RBAC/unit-scope across modules.
- Files:
  - app/Http/Middleware/HandleInertiaRequests.php
  - app/Http/Controllers/DashboardController.php
  - app/Http/Controllers/LetterController.php
  - routes/web.php
  - tests/Feature/DashboardCountersUnitScopeTest.php
  - tests/Feature/LetterMemberSearchUnitScopeTest.php
  - tests/Feature/AdminActivityLogsAccessTest.php
  - tests/Feature/AspirationCategoryAccessTest.php
  - tests/Feature/RbacUnitScopeRegressionTest.php
- Commands: none
- Decisions/Risks:
  - Notes were written after execution to keep local history consistent.
- Next: none

- Date: 2025-12-24 14:30
- Scope: backend
- Summary:
  - Point C: Letter module enhancements (SLA tracking/marking, approver delegation, templates/defaults, read tracking, notification preference gating).
  - Added `GET /letters/template-render` for template prefill and scheduled `letters:sla-mark` hourly.
- Files:
  - config/letters.php
  - routes/console.php
  - routes/web.php
  - app/Console/Commands/LettersSlaMarkCommand.php
  - app/Http/Controllers/LetterController.php
  - app/Http/Controllers/Admin/LetterApproverController.php
  - app/Http/Controllers/Admin/LetterCategoryController.php
  - app/Models/Letter.php
  - app/Models/LetterApprover.php
  - app/Models/LetterCategory.php
  - app/Models/NotificationPreference.php
  - app/Policies/LetterPolicy.php
  - app/Services/LetterTemplateRenderer.php
  - database/migrations/2025_12_24_033046_add_sla_columns_to_letters_table.php
  - database/migrations/2025_12_24_033913_create_letter_approvers_table.php
  - database/migrations/2025_12_24_034831_add_template_columns_to_letter_categories_table.php
- Commands: see `development-notes/testing.md`
- Decisions/Risks:
  - Template render context is intentionally minimal (no email/phone/address).
  - Category template/default values are optional; UI confirms before overwriting draft content.
- Next:
  - Validate end-to-end flows with `admin_unit` and `admin_pusat` roles after any future changes.

- Date: 2025-12-24 15:50
- Scope: backend
- Summary:
  - Point D: Added batch import (preview/commit) with `import_batches` + `import_batch_errors`, audit events, and CSV error report download.
- Files:
  - database/migrations/2025_12_24_152000_create_import_batches_table.php
  - database/migrations/2025_12_24_152001_create_import_batch_errors_table.php
  - database/migrations/2025_12_24_154000_add_commit_columns_to_import_batches_table.php
  - app/Models/ImportBatch.php
  - app/Models/ImportBatchError.php
  - app/Services/MemberImportService.php
  - app/Http/Controllers/Admin/MemberImportController.php
  - routes/web.php
  - tests/Feature/MemberImportPreviewTest.php
  - tests/Feature/MemberImportCommitTest.php
- Commands: see `development-notes/testing.md`
- Decisions/Risks:
  - `import_batch_errors` stores only a preview sample to avoid DB bloat; full errors are recomputed from the stored file for download.
- Next: none

- Date: 2025-12-24 17:20
- Scope: backend
- Summary:
  - Point D: Hardened exports with unit scoping, PII masking for non-global users, and audit trail for export actions (members/mutations/finance/reports).
- Files:
  - app/Services/ExportScopeHelper.php
  - routes/web.php
  - app/Http/Controllers/Finance/FinanceCategoryController.php
  - app/Http/Controllers/Finance/FinanceLedgerController.php
  - tests/Feature/ExportPiiMaskingTest.php
- Commands: see `development-notes/testing.md`
- Decisions/Risks:
  - `reports.documents` masks NIP for non-global users.
- Next: none

- Date: 2025-12-24 17:50
- Scope: backend
- Summary:
  - Point D: Finalized import hardening (unit-scoped upsert, global requires unit per row), added XLSX/XLS parsing for batch flow, and added import UI route.
- Files:
  - app/Services/MemberImportService.php
  - app/Http/Controllers/Admin/MemberImportController.php
  - routes/web.php
  - tests/Feature/MemberImportIdorTest.php
- Commands: see `development-notes/testing.md`
- Decisions/Risks:
  - Legacy `POST /admin/members/import` is kept for backward compatibility but internally uses batch flow for audit and scope rules.
- Next:
  - Prefer `/admin/members/import` wizard for operators.

- Date: 2025-12-24 19:24
- Scope: backend
- Summary:
  - Point D: Moved export audit logging to run before streaming so audit rows exist even when the stream body is not consumed (members/mutations/finance).
  - Aligned member import audit logs to use `event_category=export` for consistent filtering/retention.
- Files:
  - routes/web.php
  - app/Http/Controllers/Finance/FinanceCategoryController.php
  - app/Http/Controllers/Finance/FinanceLedgerController.php
  - app/Http/Controllers/Admin/MemberImportController.php
- Commands: see `development-notes/testing.md`
- Decisions/Risks:
  - Export routes now run an extra `COUNT(*)` query to record `row_count` before streaming.
- Next: none

- Date: 2025-12-30 20:30
- Scope: backend
- Summary:
  - Forum Integration: Installed `riari/laravel-forum:^7.0` package with `livewire-tailwind` preset.
  - Published forum config, translations, and migrations via `vendor:publish`.
  - Created `ForumCategorySeeder` with 3 categories (Pengumuman Anggota, Pengumuman Pengurus, Diskusi Umum).
  - Created `AnnouncementService.php` for role-based announcement fetching with caching.
  - Updated `DashboardController.php` to pass announcements to frontend.
- Files:
  - composer.json (added `riari/laravel-forum:^7.0`)
  - config/forum/frontend.php, config/forum/general.php, config/forum/integration.php
  - database/migrations/2014_05_19_*_create_forum_table_*.php (5 migrations)
  - database/seeders/ForumCategorySeeder.php (NEW)
  - app/Services/AnnouncementService.php (NEW)
  - app/Http/Controllers/DashboardController.php
  - app/Policies/ForumCategoryPolicy.php (NEW)
  - app/Providers/AuthServiceProvider.php
  - vite.config.js
  - tailwind.config.js
  - resources/forum/livewire-tailwind/css/forum.css
- Commands:
  - composer require riari/laravel-forum:^7.0
  - php artisan vendor:publish --provider="TeamTeaTime\Forum\ForumServiceProvider"
  - php artisan migrate
  - php artisan forum:preset-install livewire-tailwind
  - php artisan db:seed --class=ForumCategorySeeder
  - npm run build
- Decisions/Risks:
  - Used `livewire-tailwind` preset which requires `livewire/livewire` package (pending install).
  - Forum CSS `@apply` directives converted to plain CSS for Tailwind v4 compatibility.
  - Category colors use `color_light_mode`/`color_dark_mode` columns per schema.
- Next:
  - Install `livewire/livewire` to resolve HTTP 500 error.
  - Complete Phase 5 (Notification integration) after forum is functional.

- Date: 2025-12-30 21:10
- Scope: backend
- Summary:
  - Phase 5: Forum Notification Integration completed.
  - Added `NewAnnouncementNotification` for database channel notifications.
  - Added `ForumThreadCreatedListener` to trigger notifications on new threads in announcement categories, respecting user preferences.
- Files:
  - app/Notifications/NewAnnouncementNotification.php (NEW)
  - app/Listeners/ForumThreadCreatedListener.php (NEW)
  - app/Providers/AppServiceProvider.php
  - app/Models/NotificationPreference.php
- Decisions/Risks:
  - Listener uses `NotificationPreference::isChannelEnabled` generic check (opt-out model).
- Next: none

- Date: 2025-12-31 10:55
- Scope: backend
- Summary:
  - Forum Feature Rollback: Removed `riari/laravel-forum` package and all related integrations due to excessive complexity/conflict risks.
  - Fully cleaned up database (dropped 4 forum tables), migrations, and configuration.
  - Removed `AnnouncementService`, `ForumThreadCreatedListener`, and stripped announcement logic from `DashboardController`.
  - Fixed Vite build error caused by lingering references to deleted forum CSS/JS files.
- Files:
  - composer.json
  - config/forum/* (DELETED)
  - resources/forum/* (DELETED)
  - database/migrations/*forum*.php (DELETED)
  - app/Services/AnnouncementService.php (DELETED)
  - app/Http/Controllers/DashboardController.php
  - app/Providers/AppServiceProvider.php
  - app/Providers/AuthServiceProvider.php
  - vite.config.js
- Commands:
  - composer remove riari/laravel-forum teamteatime/laravel-forum
  - mysql -e "DROP TABLE..."
  - npm run build (verified fix)
- Decisions/Risks:
  - Future forum/announcement needs should be met with a custom, lightweight Implementation rather than a heavy package.
  - `clean` state restored; no forum artifacts remain in codebase.
- Next: none

- Date: 2025-12-31 13:20
- Scope: backend
- Summary:
  - Implemented Announcements backend foundation (Prompt 1/4).
  - Created `announcements` and `announcement_attachments` tables + models.
  - Implemented `AnnouncementPolicy` with strict scope logic (global/officer/unit).
  - Added routes for viewing, managing (admins only), and downloading attachments.
- Files:
  - database/migrations/2025_12_31_061221_create_announcements_tables.php (NEW)
  - app/Models/Announcement.php (NEW)
  - app/Models/AnnouncementAttachment.php (NEW)
  - app/Policies/AnnouncementPolicy.php (NEW)
  - app/Policies/AnnouncementAttachmentPolicy.php (NEW)
  - app/Providers/AuthServiceProvider.php
  - app/Http/Controllers/AnnouncementController.php (NEW)
  - routes/web.php
- Decisions:
  - Policy handles visibility logic: `view` checks `is_active` + scope type.
  - `admin_unit` restricted to their own unit id in Policy `create`/`update`.
  - Attachments use private storage (`local` disk default), requires auth check to download.
- Next: Prompt 2 (CRUD UI + full validation implementation)

- Date: 2025-12-31 13:45
- Scope: admin crud
- Summary:
  - Implemented `Admin\AnnouncementController` for management.
  - Added `AnnouncementRequest` with strict scope enforcement (forcing unit scope/id for admin_unit).
  - Updated `web.php` with resource routes and toggle actions.
- Files:
  - app/Http/Controllers/Admin/AnnouncementController.php (NEW)
  - app/Http/Requests/Admin/AnnouncementRequest.php (NEW)
  - routes/web.php

- Date: 2025-12-31 14:05
- Scope: attachments
- Summary:
  - Implemented `AnnouncementAttachmentService` (private storage in `announcements/{id}/{uuid}`).
  - Added `AnnouncementAttachmentController` (Admin) for uploading/deleting.
  - Added `AnnouncementAttachmentUploadRequest` validation (5MB max, mimes: pdf/office/images).
- Files:
  - app/Services/AnnouncementAttachmentService.php (NEW)
  - app/Http/Controllers/Admin/AnnouncementAttachmentController.php (NEW)
  - app/Http/Requests/Admin/AnnouncementAttachmentUploadRequest.php (NEW)

- Date: 2025-12-31 14:15
- Scope: public list & dashboard
- Summary:
  - Updated `DashboardController` to inject `pinned_announcements` (scoped by `visibleTo`).
  - Implemented `AnnouncementController@index` for public list (scoped + searchable).
  - Used `visibleTo` scope consistently to ensure security.
- Files:
  - app/Http/Controllers/DashboardController.php
  - app/Http/Controllers/AnnouncementController.php

- Date: 2025-12-31 15:40
- Scope: backend
- Summary:
  - Fixed announcements save flow by enforcing scope/unit in `AnnouncementRequest::prepareForValidation()` and using `$request->validated()` in admin controller writes.
  - Standardized unit scoping to use `User::currentUnitId()` for admin_unit queries/defaults.
- Files:
  - app/Http/Requests/Admin/AnnouncementRequest.php
  - app/Http/Controllers/Admin/AnnouncementController.php
  - app/Models/Announcement.php
- Commands:
  - npm run build
- Decisions/Risks:
  - Validation now fails clearly when an admin_unit account has no unit (prevents silently creating malformed unit announcements).
- Next: none

- Date: 2026-01-03 05:30
- Scope: backend
- Summary:
  - Implemented Global Feature Toggle system for maintenance/incident response.
  - Created `config/features.php` with 3 flags: announcements, letters, finance.
  - Created `EnsureFeatureEnabled` middleware returning 503 when feature disabled.
  - Registered `feature` middleware alias in `bootstrap/app.php`.
  - Applied `feature:announcements` guard to public and admin announcements routes.
- Files:
  - config/features.php (NEW)
  - app/Http/Middleware/EnsureFeatureEnabled.php (NEW)
  - bootstrap/app.php
  - routes/web.php
  - tests/Feature/FeatureToggleTest.php (NEW)
- Env Variables:
  - FEATURE_ANNOUNCEMENTS=true|false (default: true)
  - FEATURE_LETTERS=true|false (default: true)
  - FEATURE_FINANCE=true|false (default: true)
- Usage:
  - To disable a feature: set FEATURE_X=false in .env
  - Run: php artisan config:cache (or config:clear)
  - Routes will return 503 Service Unavailable
- Decisions/Risks:
  - Unknown feature names default to allowed (fail-safe).
  - No DB table needed; pure config/env approach.
- Next: Apply guards to letters and finance routes as needed.

- Date: 2026-01-03 05:47
- Scope: backend
- Summary:
  - Cleaned up leftover forum migration files that referenced missing `forum_*` tables and broke fresh DB setups.
  - Reset local SQLite database to a clean state and re-ran migrations + seeders.
- Files:
  - database/migrations/*forum*.php (deleted leftovers)
  - database/database.sqlite (recreated)
- Commands:
  - php artisan migrate:fresh --seed
- Decisions/Risks:
  - Local DB reset removes existing local data; only use on development machines.
- Next: none

- Date: 2026-01-03 05:52
- Scope: backend
- Summary:
  - Feature Toggle UI: Shared feature flags to Inertia props via HandleInertiaRequests.
  - DashboardController: Skip announcements query when feature is disabled (performance).
- Files:
  - app/Http/Middleware/HandleInertiaRequests.php
  - app/Http/Controllers/DashboardController.php
- Decisions/Risks:
  - Props use fail-safe: missing feature defaults to true.
- Next: none


- Date: 2026-01-03 05:58
- Scope: backend
- Summary:
  - Hardened global_officers audience: now based on union_position, not role.
  - Added `User::isOfficer()` method to check if user is an officer (union_position != Anggota).
  - Super admin and admin_pusat always return true from isOfficer() for operational purposes.
  - Updated `AnnouncementPolicy::view()` to use isOfficer().
  - Updated `Announcement::scopeVisibleTo()` to use isOfficer().
- Files:
  - app/Models/User.php
  - app/Policies/AnnouncementPolicy.php
  - app/Models/Announcement.php
  - tests/Feature/AnnouncementOfficersAudienceTest.php (NEW)
- Decisions/Risks:
  - Users without member linkage cannot see global_officers (except super_admin/admin_pusat).
  - Definition change may affect existing users who had role != anggota but position = Anggota.
- Next: none

- Date: 2026-01-03 19:22
- Scope: backend
- Summary:
  - Fixed QR code preview for letters: QR now only generated for final statuses (approved/sent/archived).
  - `LetterController@preview()`: Added `isFinal` check before QR generation, passes `isFinal` prop to frontend.
  - `LetterController@qrCode()`: Added 403 guard for non-final letters, changed catch to `\Throwable`.
- Files:
  - app/Http/Controllers/LetterController.php
  - tests/Feature/LetterQrPreviewTest.php (NEW)
- Commands:
  - php artisan test --filter LetterQrPreviewTest
- Decisions/Risks:
  - Non-final letters no longer return QR from `/letters/{id}/qr.png` (returns 403).
  - `isFinal` flag sent to frontend for conditional UI rendering.
- Next: none

- Date: 2026-01-03 20:07
- Scope: backend
- Summary:
  - Implemented monthly dues generator command `dues:generate`.
  - Created `config/dues.php` with `default_amount` (30000), `due_day`, `generate_on_day`.
  - Command supports `--period`, `--backfill`, and `--dry-run` options.
  - Uses `insertOrIgnore` for idempotent inserts (won't duplicate or overwrite existing).
  - Added monthly schedule in `bootstrap/app.php` (day 1 at 00:10).
- Files:
  - config/dues.php (NEW)
  - app/Console/Commands/GenerateMonthlyDues.php (NEW)
  - bootstrap/app.php
  - tests/Feature/DuesGenerateCommandTest.php (NEW)
- Commands:
  - php artisan dues:generate --period=2026-01
  - php artisan dues:generate --backfill=2025-01 --period=2026-01
  - php artisan test --filter DuesGenerateCommandTest
- Decisions/Risks:
  - Backfill limited to 24 months max for safety.
  - Inactive members excluded from generation.
- Next: none

- Date: 2026-01-03 20:12
- Scope: backend
- Summary:
  - Implemented "Iuran Saya" (Member Dues) page for all users to view personal dues history.
  - Created `MemberDuesController@index` returning 12 months with virtual unpaid for missing records.
  - Added `getMyDuesSummary()` to `DashboardController` for personal dues dashboard card.
  - Route `/member/dues` with `feature:finance` middleware.
- Files:
  - app/Http/Controllers/Member/MemberDuesController.php (NEW)
  - app/Http/Controllers/DashboardController.php
  - routes/web.php
  - tests/Feature/MemberDuesPageTest.php (NEW)
- Commands:
  - php artisan test --filter MemberDuesPageTest
- Decisions/Risks:
  - Data syncs via `dues_payments` table - bendahara changes reflect on member page.
  - Users without member_id see empty state.
- Next: none

- Date: 2026-01-03 20:18
- Scope: backend
- Summary:
  - Hardened dues module with policy enforcement and audit logging.
  - `DuesPaymentPolicy`: `viewAny()` allows all users, `view()` has member self-access, `update()` restricted to Bendahara/Global (Admin Unit removed).
  - `FinanceDuesController`: Added `authorize()` calls to `index()`, `update()`, `massUpdate()`.
  - Audit logging: `dues.mark_paid`, `dues.mark_unpaid`, `dues.batch_mark_paid`.
- Files:
  - app/Policies/DuesPaymentPolicy.php
  - app/Http/Controllers/Finance/FinanceDuesController.php
  - tests/Feature/DuesAuthorizationTest.php (NEW)
- Commands:
  - php artisan test --filter DuesAuthorizationTest
- Decisions/Risks:
  - Admin Unit users can no longer update dues (view-only).
  - Cross-unit update attempts return 403.
  - All dues updates now logged to audit_logs table.
- Next: none

- Date: 2026-01-04 06:17
- Scope: backend
- Summary:
  - Made dues generator skip counts precise by separating existing vs ineligible-by-join-date records.
  - Audit payload now includes skipped breakdown for clearer operational tracking.
- Files:
  - app/Console/Commands/GenerateMonthlyDues.php
- Commands: none
- Decisions/Risks:
  - Skipped counts now reflect actual reasons; no behavior change to records created.
- Next: none
- Date: 2026-01-04 07:51
- Scope: backend
- Summary:
  - Changed dashboard counters `members_total` and `units_total` to always return nationwide totals for all users (not unit-scoped).
  - Kept unit-scoped counts via existing `members_unit_total` and other scoped metrics (mutations/onboarding/updates).
- Files:
  - app/Http/Middleware/HandleInertiaRequests.php
  - tests/Feature/DashboardCountersUnitScopeTest.php
  - tests/Feature/RbacUnitScopeRegressionTest.php
- Commands:
  - php artisan test --filter DashboardCountersUnitScopeTest
  - php artisan test --filter RbacUnitScopeRegressionTest
- Decisions/Risks:
  - Non-global users can now see nationwide totals (visibility only); links remain role-gated in UI.
- Next: none

- Date: 2026-01-04 11:40
- Scope: backend
- Summary:
  - Fixed members import 404 by constraining `/admin/members/{member}` to numeric IDs so `/admin/members/import` resolves correctly.
- Files:
  - routes/web.php
- Commands: none
- Decisions/Risks:
  - Member routes now only match numeric IDs; safe given current primary key type.
- Next: none

- Date: 2026-01-04 12:12
- Scope: backend
- Summary:
  - Added QrCodeService to generate SVG when Imagick is unavailable and reused it for letter preview/pdf/qr routes and member card QR.
  - Letter preview now includes `qrMime` so UI can render SVG data URIs.
- Files:
  - app/Services/QrCodeService.php
  - app/Http/Controllers/LetterController.php
  - app/Http/Controllers/Member/CardController.php
  - resources/views/letters/pdf.blade.php
- Commands:
  - php -r '...QrCodeService::generate(...)'
- Decisions/Risks:
  - SVG QR is used when Imagick extension is missing; PDF rendering depends on Dompdf SVG support (fallback to verify URL still available).
- Next: none

- Date: 2026-01-04 19:20
- Scope: backend
- Summary:
  - Implemented Role-Aware Global Search.
  - Features:
    - Search across Announcements, Letters, Aspirations, and Members.
    - Role-aware scoping (Anggota sees own data; Admin Unit sees unit data; Super Admin sees all).
    - API endpoint with throttling (30/min).
- Files:
  - app/Services/SearchService.php (NEW)
  - app/Http/Controllers/SearchController.php (NEW)
  - routes/web.php
  - tests/Feature/SearchApiTest.php (NEW)
- Commands:
  - php artisan test --filter SearchApiTest
- Decisions/Risks:
  - SearchService currently handles basic LIKE queries; Full-text search (Scout) deferred to future phase.
  - Member search is restricted to Admin Unit roles and above.
- Next: none


- Date: 2026-01-04 19:55
- Scope: backend
- Summary:
  - Hardened Global Search (`SearchService`, `SearchController`).
  - Added Database Indexes:
    - `announcements`: `title`, `created_at`
    - `letters`: `subject`, `status`, `created_at`
    - `aspirations`: `status`, `created_at`
    - `members`: `full_name`, `kta_number`, `organization_unit_id`
  - Validation:
    - Enforced `min:2`, `max:80` chars on search queries.
    - Rate Limit: Tightened `/api/search` to 15 requests/min.
  - Architecture:
    - Refactored `SearchService` to use `baseXQuery` methods for consistent scoping.
    - Implemented `maskPii` to hide emails/phone for non-privileged users.
  - Auditing:
    - Privileged searches (Admin Pusat/Super Admin) now logged via `AuditService`.
    - Log payload includes `query_hash` (SHA256) and `query_len` (no raw PII query stored).
- Files:
  - `database/migrations/2026_01_04_123558_add_search_indexes_to_tables.php`
  - `app/Services/SearchService.php`
  - `app/Http/Controllers/SearchController.php`

- Date: 2026-01-04 20:32
- Scope: backend
- Summary:
  - Completed Global Search S1–S4 with additional domains: `users`, `dues_payments`, `finance_ledgers` (role + feature flag aware).
  - Fixed audit logging for privileged search (payload whitelist now allows `query_hash`/`query_len`/`type_scope`/`role`).
  - Added `/admin/users/{id}` detail page and policy.
  - Improved finance ledger deep-linking via `?focus=` to surface a specific row.
  - Fixed/updated factories and search tests to match current schema.
- Files:
  - app/Http/Controllers/SearchController.php
  - app/Services/SearchService.php
  - app/Http/Controllers/Finance/FinanceLedgerController.php
  - app/Http/Controllers/Admin/UserController.php
  - app/Policies/UserPolicy.php
  - app/Providers/AuthServiceProvider.php
  - config/audit.php
  - routes/web.php
  - database/factories/AspirationFactory.php
  - database/factories/AspirationCategoryFactory.php
  - resources/js/Pages/Admin/Users/Show.vue
  - resources/js/Pages/Finance/Ledgers/Index.vue
  - tests/Feature/SearchApiTest.php
  - tests/Feature/SearchPageTest.php
  - tests/Feature/SearchSecurityTest.php
- Commands:
  - php artisan test --filter Search --testsuite Feature
- Decisions/Risks:
  - Finance ledger search links to `edit` only when allowed by policy; otherwise falls back to `index?focus=...`.
- Next:
  - Optional: add dedicated `finance.ledgers.show` (read-only) to avoid routing users to edit/index flows.

- Date: 2026-01-04 20:39
- Scope: backend
- Summary:
  - Fixed announcement search result links to only use admin edit URL when user is authorized to update; otherwise link to public show page.
- Files:
  - app/Services/SearchService.php
- Commands:
  - php artisan test --filter Search --testsuite Feature
- Decisions/Risks: none
- Next: none

- Date: 2026-01-05 04:30
- Scope: backend
- Summary:
  - R1: Implemented Reports CSV Export Foundation with RBAC + Scope + Audit + Streaming.
  - Added `reports` feature flag to `config/features.php` (FEATURE_REPORTS env var).
  - Created `ReportsExportController` with dispatcher pattern for multiple report types.
  - Implemented `members` type end-to-end with streaming CSV export.
  - Enhanced `ExportScopeHelper::auditExport()` with `report_type`, `format`, and PII filter for `q` parameter.
  - Extended reports routes to include `admin_pusat` and `bendahara` roles.
  - Added `throttle:10,1` to new export endpoint.
- Files:
  - config/features.php
  - app/Services/ExportScopeHelper.php
  - app/Http/Controllers/ReportsExportController.php (NEW)
  - routes/web.php
  - tests/Feature/ReportsExportScopeTest.php (NEW)
- Commands:
  - php artisan test --filter ReportsExportScopeTest
- Env Variables:
  - FEATURE_REPORTS=true|false (default: true)
  - To disable: set FEATURE_REPORTS=false, then php artisan config:cache
- Decisions/Risks:
  - Unimplemented types (aspirations, dues, finance_ledgers) return 501 but are audited.
  - Non-global users (admin_unit, bendahara) forced to own unit; cannot inject unit_id.
- Next:
  - R2/R3: Implement remaining report types (aspirations, dues, finance_ledgers).

- Date: 2026-01-05 04:50
- Scope: backend
- Summary:
  - R2: Implemented enhanced members and new aspirations CSV exports.
  - Members export: Added filters (union_position_id, q search, include_documents), enhanced CSV columns, search query hashing for audit.
  - Aspirations export: Full implementation with status/date filters, q search, optional member/user columns.
  - PII masking via `ExportScopeHelper::shouldMaskPii()` for non-global users.
  - Search query hashing: `q_len` and `q_hash` stored in audit payload instead of raw query.
  - Added `AspirationPolicy::export()` for authorization.
- Files:
  - app/Http/Controllers/ReportsExportController.php
  - app/Policies/AspirationPolicy.php
  - tests/Feature/ReportsExportScopeTest.php
- Commands:
  - php artisan test --filter ReportsExport
- Decisions/Risks:
  - Search query `q` is NOT stored in audit payload (PII risk); stored as `q_len` + `q_hash` (sha256).
  - Aspirations body is truncated to 200 chars with HTML stripped in CSV output.
- Next:
  - R3: Implement dues and finance_ledgers report types.

- Date: 2026-01-05 05:25
- Scope: backend
- Summary:
  - R3: Implemented 5 new Finance & Dues CSV report types.
  - `dues_per_period`: Detail iuran member/bulan, status paid/unpaid, nominal, recorded_by.
  - `dues_summary`: Rekap pembayaran (count & amount) per unit per bulan.
  - `dues_audit`: Audit log export untuk konfirmasi pembayaran/pembatalan iuran.
  - `finance_ledgers`: Ledger transaksi income/expense lengkap dengan approval info.
  - `finance_monthly_summary`: Rekap bulanan income/expense dan net balance per unit.
  - All finance reports protected by `features.finance` flag (returns 503 if disabled).
  - Strict scope enforced: admin_unit/bendahara only see their unit data.
- Files:
  - app/Http/Controllers/ReportsExportController.php
  - tests/Feature/ReportsFinanceExportScopeTest.php
- Commands:
  - php artisan test --filter ReportsFinanceExportScopeTest
- Decisions/Risks:
  - `finance_monthly_summary` uses in-memory aggregation for current year; efficient enough for current scale.
  - `dues_per_period` left joins ensure even unpaid members appear in the list.
- Date: 2026-01-05 05:40
- Scope: backend
- Summary:
  - R4: Implemented Report Export Status & Documentation.
  - Added `ReportExportStatus` service using global Cache with TTL 600s.
  - Start/Complete/Fail states tracked per-user for UI feedback.
  - Endpoint `GET /reports/export/status` exposes status.
  - Documentation available at `GET /docs/reports/csv` (Docs/Viewer) loading `reports-csv.md`.
  - Updated `ReportsExportController` to inject status service and track lifecycle.
- Files:
  - app/Services/ReportExportStatus.php (NEW)
  - app/Http/Controllers/ReportsExportStatusController.php (NEW)
  - app/Http/Controllers/ReportsExportController.php
  - routes/web.php
  - resources/markdown/reports-csv.md (NEW)
  - tests/Feature/ReportsExportStatusTest.php (NEW)
- Commands:
  - php artisan test --filter ReportsExportStatusTest
- Decisions/Risks:
  - Status is ephemeral (cache-based), perfect for "currently exporting" UI.
  - No database table required for status tracking.
- Next: None

- Date: 2026-01-05 06:34
- Scope: backend
- Summary:
  - Memindahkan dokumen “Panduan Export CSV” dari endpoint `/docs/reports/csv` ke Help Center (`/docs/help/reports-csv`), dengan redirect backward-compatible.
  - Menambahkan file docs baru `docs/help/reports-csv.md`; file lama `resources/markdown/reports-csv.md` ditandai deprecated.
- Files:
  - routes/web.php
  - docs/help/reports-csv.md
  - resources/markdown/reports-csv.md
- Commands: none
- Decisions/Risks:
  - URL lama `/docs/reports/csv` masih ada sebagai redirect agar link lama tidak rusak.
- Next: none

- Date: 2026-01-05 09:49
- Scope: backend
- Summary:
  - Added PATCH /settings/profile endpoint.
  - Updates user name and linked member full_name transactionally.
  - Logs activity as 'profile_update'.
- Files: web.php, tests/Feature/SettingsProfileTest.php
- Commands: php artisan test tests/Feature/SettingsProfileTest.php
- Decisions/Risks:
  - Logic in closure for consistency with existing settings routes.
- Next: none

- Date: 2026-01-05 09:53
- Scope: backend
- Summary:
  - Added GET /settings/sessions endpoint (returns 10 latest).
  - Added POST /settings/sessions/revoke-others endpoint (deletes non-current sessions).
  - Added audit logging for revocations.
- Files: web.php
- Decisions/Risks:
  - Using DB façade to query 'sessions' table directly.
- Next: none

- Date: 2026-01-05 09:57
- Scope: backend
- Summary:
  - Updated NotificationService to support role-aware default channels.
  - Bendahara gets email enabled by default for finance/dues.
  - Admin Unit gets email enabled by default for onboarding/updates/aspirations.
  - Updated PATCH /settings/notifications validation to accept new categories (announcements, dues, reports, finance).
- Files: app/Services/NotificationService.php, routes/web.php
- Decisions/Risks:
  - Default logic only applies if no preference record exists for the user.
- Next: none

- Date: 2026-01-05 10:32
- Scope: backend
- Summary:
  - Added PATCH /settings/password to update user password with current-password verification.
  - Logs password change in ActivityLog and logs out other devices after update.
- Files:
  - routes/web.php
- Commands: none
- Decisions/Risks:
  - Password change requires current password; SSO users may need a separate flow.
- Next: none

- Date: 2026-01-05 11:28
- Scope: backend
- Summary:
  - Shared `csrf_token` via Inertia props to support fetch-based settings actions.
- Files:
  - app/Http/Middleware/HandleInertiaRequests.php
- Commands: none
- Decisions/Risks:
  - None.
- Next: none

- Date: 2026-01-05 10:38
- Scope: backend
- Summary:
  - Fixed Dashboard Scoping for Recent Mutations and Recent Activity.
  - Implemented  and  in .
  - Logic: Global users see all; Unit users see only their unit's data (mutations involving their unit, activity within their unit).
  - Passed new data props to Dashboard Inertia view.
- Files: app/Http/Controllers/DashboardController.php
- Decisions/Risks:
  - Auth/Reguler events excluded from Activity stream to reduce noise/confusion for non-admin users.
- Next: none

- Date: 2026-01-06 23:56
- Scope: backend
- Summary:
  - Implemented Optional Secondary Approver for Letters (dual approval flow).
  - Added DB columns: `signer_type_secondary`, `approved_primary_at`, `approved_secondary_by_user_id`, `approved_secondary_at`.
  - Letter model: helper methods `requiresSecondaryApproval()`, `isPrimaryApproved()`, `isSecondaryApproved()`, relation `approvedSecondaryBy()`.
  - LetterController: 2-step `approve()` logic, updated `approvals()` query for dual flow, added `notifySecondaryApprover()`.
  - LetterPolicy: `canApprove()` now checks primary vs secondary slot pending.
  - LetterApproverController: Added `bendahara` to signer_type validation.
- Files:
  - database/migrations/2026_01_06_235600_add_secondary_approval_to_letters_table.php
  - app/Models/Letter.php
  - app/Http/Controllers/LetterController.php
  - app/Policies/LetterPolicy.php
  - app/Http/Controllers/Admin/LetterApproverController.php
- Commands:
  - php artisan migrate
- Decisions/Risks:
  - Single approval flow unchanged when `signer_type_secondary` is NULL.
  - Dual flow: primary approves first (status stays `submitted`), then secondary approves (status becomes `approved` + letter number assigned).
- Next: Frontend UI to select secondary approver in letter form.

- Date: 2026-01-07 18:52
- Scope: backend
- Summary:
  - Persisted external recipient address (`to_external_address`) on letter create/update.
- Files:
  - app/Http/Controllers/LetterController.php
- Commands: none
- Decisions/Risks:
  - Validation already allows optional address; no schema changes needed.
- Next: none

- Date: 2026-01-07 09:34
- Scope: backend
- Summary:
  - TE2: Implemented HTML sanitization for letter body field (anti-XSS).
  - Created `HtmlSanitizerService` with DOMDocument-based whitelist approach.
  - Allowed tags: p, br, strong, b, em, i, u, s, ul, ol, li, blockquote, h2, h3, hr, a, span.
  - Sanitizes href (only http/https/mailto), forces target="_blank" + rel="noopener noreferrer".
  - Style whitelist: only text-align (left/center/right/justify).
  - Strips script, iframe, object, event handlers (onclick etc), javascript: links.
  - Updated `LetterController` to sanitize body in store() and update() methods.
  - Increased body validation max length to 50000 characters.
- Files:
  - app/Services/HtmlSanitizerService.php (NEW)
  - app/Http/Controllers/LetterController.php
  - tests/Feature/HtmlSanitizerServiceTest.php (NEW)
- Commands:
  - php artisan test --filter HtmlSanitizerServiceTest
- Decisions/Risks:
  - No new composer packages (uses built-in DOMDocument).
  - Plain text templates are auto-converted to HTML paragraphs.
  - Link validation rejects javascript:, data:, vbscript:, file: schemes.
- Next: none

- Date: 2026-01-07 18:32
- Scope: backend
- Summary:
  - F2: Hardened two-step approval flow.
  - approve(): Notifications (notifyCreator, notifyRecipients) now only called on FINAL approval, not stage 1.
  - LetterPolicy: send() requires status='approved', archive() requires status in ['approved','sent'] for ALL users including superadmin.
  - preview()/pdf(): Now loads approvedSecondaryBy relation.
  - Prevents premature "send" or "archive" of letters still awaiting secondary approval.
- Files:
  - app/Http/Controllers/LetterController.php
  - app/Policies/LetterPolicy.php
- Commands: none
- Decisions/Risks:
  - Stage 1 approval: status remains 'submitted', only notifies secondary approver.
  - Superadmin cannot bypass status requirement for send/archive.
- Next: none
- Date: 2026-01-08 10:44
- Scope: backend
- Summary:
  - Mutation Hardening: Implemented duplicate prevention and cancel flow.
  - Block duplicate: `MutationController::store()` now checks for existing pending mutation before creating.
  - Cancel flow: Added `cancel()` method to controller with status update, timestamps, and activity logging.
  - Migration: Added `cancelled_at` and `cancelled_by_user_id` columns to `mutation_requests`.
  - Route: Added `POST /admin/mutations/{mutation}/cancel`.
- Files:
  - app/Http/Controllers/Admin/MutationController.php
  - app/Policies/MutationRequestPolicy.php
  - routes/web.php
  - database/migrations/2026_01_08_034500_add_cancelled_columns_to_mutation_requests.php
  - resources/js/Pages/Admin/Mutations/Index.vue
  - tests/Feature/MutationDuplicatePreventionTest.php (NEW)
  - tests/Feature/MutationCancelFlowTest.php (NEW)
- Commands:
  - php artisan migrate
  - php artisan test tests/Feature/MutationDuplicatePreventionTest.php
  - php artisan test tests/Feature/MutationCancelFlowTest.php
- Decisions/Risks:
  - Active status = pending only (approved/rejected are final states).
  - No DB-level unique constraint due to SQLite/MySQL partial index limitations; application guard is sufficient.
- Next: none

