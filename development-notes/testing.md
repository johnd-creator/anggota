# Testing notes (local-only)

This file is intentionally ignored by git (stored under `development-notes/`).
Do not put secrets (tokens, passwords, `.env` contents) or production data here.

## Quick Commands

- Run all tests: `php artisan test`
- Run audit-related tests:
  - `php artisan test --filter AuditTrailTest`
  - `php artisan test --filter AuditPurgeTest`
  - `php artisan test --filter PrivilegedAccessAuditTest`

## Common Setup

- Ensure dependencies installed:
  - PHP: `composer install`
  - Node: `npm ci`
- Ensure app key exists: `php artisan key:generate`
- Ensure database ready (SQLite example):
  - `php artisan migrate --force`
  - `php artisan db:seed --force`

## Common Issues

- **Cannot write `storage/logs/laravel.log`** (permission denied)
  - Fix permissions for `storage/` and `bootstrap/cache/` for your user/web server.
  - Re-run the failing command after fixing.
- **Pest result cache warning** writing under `vendor/pestphp/pest/.temp/…`
  - Usually safe to ignore; if it breaks runs, fix repo permissions for your user.

## Targeted Checks (Audit Point A)

- Verify purge command works:
  - Dry run: `php artisan audit:purge --dry-run`
  - Force: `php artisan audit:purge --force`
- Verify privileged access audit logs:
  - Hit a privileged route (e.g. `/audit-logs`, reports export, member export/import)
  - Confirm an `audit_logs` row exists with `request_id`, `status_code`, `duration_ms`

## Targeted Checks (RBAC/Unit Scope - Point B)

- Member aspirations index (admin_unit without member profile):
  - `php artisan test --filter MemberAspirationsIndexTest`

## Log

- Date: 2025-12-24 10:16
- Scope: testing
- Summary:
  - Ran focused RBAC/unit-scope regression tests and member aspirations index test.
- Files:
  - tests/Feature/MemberAspirationsIndexTest.php
- Commands:
  - php artisan test --filter MemberAspirationsIndexTest
  - php artisan test --filter RbacUnitScopeRegressionTest
- Decisions/Risks: none
- Next: none

- Date: 2026-01-07 10:03
- Scope: testing
- Summary:
  - Verified Vite build after switching Inertia pages to lazy loading; chunk sizes improved and no >800kb warnings.
- Files:
  - resources/js/app.js
- Commands:
  - npm run build
- Decisions/Risks:
  - If any page relies on side-effect imports, it will now only load when the page is visited.
- Next: none

- Date: 2026-01-04 21:14
- Scope: testing
- Summary:
  - Resolved runtime error `no such table: announcement_dismissals` by running migrations and adding defensive guards.
- Files:
  - app/Http/Controllers/DashboardController.php
  - app/Http/Controllers/AnnouncementController.php
- Commands:
  - php artisan migrate
- Decisions/Risks: none
- Next: none

- Date: 2026-01-04 21:05
- Scope: testing
- Summary:
  - Added coverage for pinned announcement dismissal behavior (per-user, dashboard hides dismissed).
- Files:
  - tests/Feature/AnnouncementDismissalTest.php
- Commands:
  - php artisan test --filter AnnouncementDismissalTest
- Decisions/Risks: none
- Next: none

- Date: 2025-12-31 15:54
- Scope: testing
- Summary:
  - Verified `vite build` still succeeds after Announcements form submit fix.
- Files:
  - resources/js/Pages/Admin/Announcements/Form.vue
- Commands:
  - npm run build
- Decisions/Risks:
  - No PHP test run in this step (test suite currently blocked by forum migration remnants).
- Next:
  - Manual E2E check for announcements CRUD in browser.

- Date: 2025-12-31 15:30
- Scope: testing
- Summary:
  - Verified frontend build after fixing Announcements create button rendering in `actions` slot.
- Files:
  - resources/js/Pages/Admin/Announcements/Index.vue
- Commands:
  - npm run build
- Decisions/Risks:
  - Build warning about `/img/grid.svg` runtime resolution is expected and safe to ignore.
- Next: none

- Date: 2025-12-31 15:40
- Scope: testing
- Summary:
  - Verified frontend build after Announcements header/style and validation feedback changes.
  - Attempted running announcement feature tests but migrations fail due to missing forum tables (`forum_categories`) after forum rollback.
- Files:
  - resources/js/Pages/Admin/Announcements/Index.vue
  - resources/js/Pages/Admin/Announcements/Form.vue
  - tests/Feature/AdminAnnouncementCrudTest.php
  - tests/Feature/AnnouncementsVisibilityTest.php
- Commands:
  - npm run build
  - php artisan test --filter "AdminAnnouncementCrudTest|AnnouncementsVisibilityTest"
- Decisions/Risks:
  - Current test environment is blocked by leftover forum migrations; fix separately if you want the suite green.
- Next:
  - Decide whether to remove/disable forum migrations or restore forum tables in test DB.

- Date: 2025-12-24 19:24
- Scope: testing
- Summary:
  - Point D regression: verified export audit logging + member import batch flow tests after adjustments.
  - Verified frontend production build succeeds.
- Files:
  - tests/Feature/ExportPiiMaskingTest.php
  - tests/Feature/MemberImportPreviewTest.php
  - tests/Feature/MemberImportCommitTest.php
  - tests/Feature/MemberImportIdorTest.php
- Commands:
  - php artisan test --filter ExportPiiMaskingTest
  - php artisan test --filter "MemberImport(Preview|Commit|Idor)Test"
  - npm run build
- Decisions/Risks:
  - `vite build` warns `/img/grid.svg` is left to resolve at runtime (no build failure).
- Next: none

- Date: 2025-12-24 14:30
- Scope: testing
- Summary:
  - Ran targeted Point C tests (SLA, templates, approvers, read tracking, notification preferences) and verified frontend build.
- Files:
  - tests/Feature/LetterApproverDelegationTest.php
  - tests/Feature/LetterCategoryCrudTest.php
  - tests/Feature/LetterTemplateRendererTest.php
  - tests/Feature/LetterTemplateRenderTest.php
  - tests/Feature/LetterSlaTest.php
  - tests/Feature/LetterReadTrackingTest.php
  - tests/Feature/LetterNotificationPreferenceTest.php
- Commands:
  - ./vendor/bin/phpunit tests/Feature/LetterApproverDelegationTest.php
  - ./vendor/bin/phpunit tests/Feature/LetterCategoryCrudTest.php
  - ./vendor/bin/phpunit tests/Feature/LetterTemplateRendererTest.php
  - ./vendor/bin/phpunit tests/Feature/LetterTemplateRenderTest.php
  - ./vendor/bin/phpunit tests/Feature/LetterSlaTest.php
  - ./vendor/bin/phpunit tests/Feature/LetterReadTrackingTest.php
  - ./vendor/bin/phpunit tests/Feature/LetterNotificationPreferenceTest.php
  - npm run build
- Decisions/Risks:
  - Keep tests file-by-file for faster isolation; run full `php artisan test` before tagging a release.
- Next: none

- Date: 2025-12-30 20:30
- Scope: testing
- Summary:
  - Forum Integration: Documented installation and seeding commands.
  - Known issue: HTTP 500 due to missing `livewire/livewire` dependency.
  - Seeder required `frontend.enable=false` temporarily to bypass ForumServiceProvider boot error.
- Files:
  - database/seeders/ForumCategorySeeder.php
  - config/forum/frontend.php
- Commands:
  - composer require riari/laravel-forum:^7.0
  - php artisan vendor:publish --provider="TeamTeaTime\Forum\ForumServiceProvider"
  - php artisan migrate
  - php artisan forum:preset-install livewire-tailwind
  - npm i @melloware/coloris alpinejs date-fns laravel-echo nested-sort tailwindcss
  - npm run build
  - php artisan db:seed --class=ForumCategorySeeder (requires frontend.enable=false first)
  - php artisan optimize:clear
- Decisions/Risks:
  - Forum seeder uses `DB::table()` directly to avoid ForumServiceProvider boot issues.
  - Pending: `composer require livewire/livewire` to enable full forum functionality.
- Next:
  - After installing Livewire, test /forum and /dashboard pages.
  - Write feature tests for announcement visibility per role.
- Date: 2025-12-31 05:18
- Scope: testing
- Summary:
  - Forum UX cleanup: verified frontend build succeeds after removing duplicate navigation elements.
- Files:
  - resources/forum/livewire-tailwind/views/layouts/app-integrated.blade.php
  - resources/forum/livewire-tailwind/views/pages/category/index.blade.php
  - resources/forum/livewire-tailwind/views/components/loading-overlay.blade.php
- Commands:
  - npm run build (completed in 2.27s)
- Decisions/Risks:
  - Build warning about /img/grid.svg runtime resolution is expected and safe to ignore.
- Next: Manual testing of forum routes to verify no duplicate navigation appears.

- Date: 2025-12-31 05:48
- Scope: testing
- Summary:
  - CORRECTION: Applied forum layout changes to correct file (main.blade.php).
  - Build verification attempted (previous build was successful).
- Files:
  - resources/forum/livewire-tailwind/views/layouts/main.blade.php
- Commands:
  - npm run build (attempted, previous run successful in 2.27s)
- Decisions/Risks:
  - Forum uses main.blade.php as layout (hardcoded in Livewire components), not app-integrated.blade.php.
- Next: Manual testing of forum routes to verify navigation and profile dropdown work correctly.


- Date: 2025-12-31 13:45
- Scope: feature test
- Summary:
  - Created `AdminAnnouncementCrudTest`.
  - Verifies:
    - `admin_pusat` can create global.
    - `admin_unit` restriction (cannot create global, forced to unit).
    - `admin_unit` visibility (only sees own unit).
- Files:
  - tests/Feature/AdminAnnouncementCrudTest.php (NEW)

- Date: 2025-12-31 14:05
- Scope: attachment test
- Summary:
  - `AnnouncementAttachmentTest`: Verified physical file storage and deletion using `Storage::fake`.
  - Verified admin permissions for upload.

- Date: 2025-12-31 14:15
- Scope: visibility test
- Summary:
- `AnnouncementsVisibilityTest`:
    - Verified Dashboard widget props (pinned & scoped).
    - Verified Public List content (active & visible).

- Date: 2025-12-31 15:28
- Scope: testing
- Summary:
  - Verified frontend build after adjusting Announcements admin page layout slots.
- Files:
  - resources/js/Pages/Admin/Announcements/Index.vue
  - resources/js/Pages/Admin/Announcements/Form.vue
- Commands:
  - npm run build
- Decisions/Risks:
  - Build warning about `/img/grid.svg` runtime resolution is expected and safe to ignore.
- Next: none

- Date: 2026-01-03 05:30
- Scope: testing
- Summary:
  - Created `FeatureToggleTest.php` with 4 test cases:
    - Public announcements returns 503 when disabled
    - Admin announcements returns 503 when disabled
    - Public announcements works when enabled
    - Admin announcements works when enabled
- Files:
  - tests/Feature/FeatureToggleTest.php (NEW)
- Commands:
  - php artisan test --filter FeatureToggleTest
  - Note: Test suite may be blocked by leftover forum migrations (known issue from 2025-12-31).
- Decisions/Risks:
  - Tests verify middleware logic in isolation; does not run full migration suite.
- Next: Run tests after resolving forum migration remnants.

- Date: 2026-01-03 05:47
- Scope: testing
- Summary:
  - Removed leftover forum migrations that blocked fresh migrations and tests.
  - Reset local SQLite DB and confirmed tests can run again.
- Files:
  - database/migrations/*forum*.php (deleted leftovers)
  - database/database.sqlite (recreated)
- Commands:
  - php artisan migrate:fresh --seed
  - php artisan test --filter FeatureToggleTest
- Decisions/Risks:
  - This reset wipes local data; re-seed used project seeders.
- Next: Run broader `php artisan test` when ready.

- Date: 2026-01-03 05:52
- Scope: testing
- Summary:
  - Feature Toggle UI: Verified PHP syntax for modified files.
  - npm run build executed (terminal output suppressed but no errors).
  - Manual verification recommended:
    1. Set FEATURE_ANNOUNCEMENTS=false in .env
    2. php artisan config:cache
    3. Confirm: Menu "Pengumuman" hidden, Dashboard widget hidden
    4. Confirm: /announcements and /admin/announcements return 503
- Files:
  - app/Http/Middleware/HandleInertiaRequests.php
  - app/Http/Controllers/DashboardController.php
  - resources/js/Layouts/AppLayout.vue
  - resources/js/Pages/Dashboard.vue
- Commands:
  - npm run build
  - php artisan test --filter FeatureToggleTest
- Decisions/Risks:
  - Test suite previously blocked by leftover forum migrations; resolved at 2026-01-03 05:47 (deleted forum migration remnants).
- Next: none


- Date: 2026-01-03 05:58
- Scope: testing
- Summary:
  - Created AnnouncementOfficersAudienceTest.php with 6 test cases:
    - User with Anggota position cannot see global_officers
    - User with Ketua position can see global_officers
    - User without member cannot see global_officers
    - Super admin can always see global_officers
    - Admin pusat can always see global_officers
    - isOfficer() method returns correct values
- Files:
  - tests/Feature/AnnouncementOfficersAudienceTest.php (NEW)
- Commands:
  - php artisan test --filter AnnouncementOfficersAudienceTest
- Decisions/Risks:
  - Tests use factory-created members with specific union_position_id.
- Next: none

- Date: 2026-01-03 06:14
- Scope: testing
- Summary:
  - Documentation correction: removed stale warning about forum migration remnants blocking tests (already resolved).
- Files:
  - development-notes/testing.md
- Commands: none
- Decisions/Risks:
  - Keep testing notes consistent with latest repo state to avoid misleading future runs.
- Next: none

- Date: 2026-01-03 19:22
- Scope: testing
- Summary:
  - Created `LetterQrPreviewTest.php` with 8 test cases for QR code preview:
    - Approved letter preview has qrBase64 and isFinal=true
    - Draft letter preview has no QR and isFinal=false
    - Submitted letter preview has no QR and isFinal=false
    - Approved letter qr.png returns 200 with image/png
    - Draft letter qr.png returns 403
    - Submitted letter qr.png returns 403
    - Sent letter preview has QR and isFinal=true
    - Archived letter preview has QR and isFinal=true
- Files:
  - tests/Feature/LetterQrPreviewTest.php (NEW)
- Commands:
  - php artisan test --filter LetterQrPreviewTest
- Decisions/Risks:
  - Tests cover all letter statuses for both preview page and qr.png endpoint.
- Next: Run tests to verify all pass.

- Date: 2026-01-03 20:07
- Scope: testing
- Summary:
  - Created `DuesGenerateCommandTest.php` with 7 test cases:
    - Generates dues for active members
    - Idempotent (no duplicates on re-run)
    - Does not overwrite paid records
    - Dry-run does not create records
    - Backfill creates records for multiple periods
    - Excludes non-active members
    - Invalid period format fails
- Files:
  - tests/Feature/DuesGenerateCommandTest.php (NEW)
- Commands:
  - php artisan test --filter DuesGenerateCommandTest
- Decisions/Risks:
  - Tests use factory members; requires Member factory to exist.
- Next: Run tests to verify all pass.

- Date: 2026-01-03 20:12
- Scope: testing
- Summary:
  - Created `MemberDuesPageTest.php` with 4 test cases:
    - User with member sees dues history
    - User without member sees empty state
    - Dashboard contains my_dues for member
    - Dashboard my_dues null for user without member
- Files:
  - tests/Feature/MemberDuesPageTest.php (NEW)
- Commands:
  - php artisan test --filter MemberDuesPageTest
- Decisions/Risks:
  - Tests cover both page and dashboard integration.
- Next: Run tests to verify all pass.

- Date: 2026-01-03 20:18
- Scope: testing
- Summary:
  - Created `DuesAuthorizationTest.php` with 6 test cases:
    - Bendahara can update member in same unit
    - Bendahara cannot update member in different unit (403)
    - Member dues page only shows own data
    - Anggota cannot update dues (403)
    - Audit log created on dues update
    - Mass update denied for cross-unit members
- Files:
  - tests/Feature/DuesAuthorizationTest.php (NEW)
- Commands:
  - php artisan test --filter DuesAuthorizationTest
- Decisions/Risks:
  - Tests validate policy enforcement at controller level.
- Next: Run tests to verify all pass.
- Date: 2026-01-04 07:51
- Scope: testing
- Summary:
  - Updated expectations for nationwide dashboard counters (members_total, units_total) for non-global users.
  - Verified affected test suites pass.
- Files:
  - tests/Feature/DashboardCountersUnitScopeTest.php
  - tests/Feature/RbacUnitScopeRegressionTest.php
- Commands:
  - php artisan test --filter DashboardCountersUnitScopeTest
  - php artisan test --filter RbacUnitScopeRegressionTest
- Decisions/Risks:
  - Observed Pest result-cache warning due to vendor temp write permissions; tests still pass.
- Next: none

- Date: 2026-01-04 12:12
- Scope: testing
- Summary:
  - Verified QrCodeService returns SVG when Imagick is unavailable.
- Files:
  - none
- Commands:
  - php -r '...QrCodeService::generate(...)'
- Decisions/Risks:
  - None.
- Next: none

- Date: 2026-01-04 19:20
- Scope: testing
- Summary:
  - Verified Topbar Search functionality:
    - Type >= 2 chars -> Dropdown appears with results.
    - Arrow keys navigation works.
    - Enter key visits selected item OR search page if none selected.
    - Esc key closes dropdown.
    - Click outside closes dropdown.
  - Role verification:
    - Anggota sees own data only.
    - Admin Unit sees unit data.
- Files:
    - resources/js/Components/Search/TopbarSearch.vue
- Next: none


- Date: 2026-01-04 19:20
- Scope: testing
- Summary:
  - Created `SearchApiTest.php` with 4 test cases covering:
    - Validation (min query length).
    - Role-based isolation (Anggota cannot see other unit's stuff).
    - Unit-based isolation (Admin Unit cannot see other unit's members).
    - Announcement visibility scopes (Global vs Unit vs Private).
- Files:
  - tests/Feature/SearchApiTest.php
- Commands:
  - php artisan test --filter SearchApiTest
- Decisions/Risks:
  - Tests rely on factories; ensure factories are up to date.
- Next: none

- Date: 2026-01-04 19:35
- Scope: testing
- Summary:
  - Added `tests/Feature/SearchPageTest.php`.
  - Scenarios:
    - Default view (Grouped): `GET /search?q=...`
    - Filtered view (Paginated): `GET /search?q=...&type=announcements`
    - Authorization: Ensure members cannot access restricted types via `type` param (403).
  - Status: Environment issues caused exit code 2 during automated run, manual verification recommended.
- Next: none


- Next: none

- Date: 2026-01-04 19:55
- Scope: testing
- Summary:
  - Added `tests/Feature/SearchSecurityTest.php`.
  - Scenarios covering:
    - Unauthorized access (Anggota -> Member search).
    - Cross-unit isolation (Unit A -> Unit B members).
    - PII Masking logic.
    - Audit log generation.
- **Status**: Automated testing failed with `Exit Code 2` (Environment/PHPUnit issue).
- **Verification**: Performed manual verification via `verify_search_hardening.php` (Tinker) logic.
- Next: Debug PHPUnit environment.

- Date: 2026-01-04 20:32
- Scope: backend
- Summary:
  - Search-related feature tests now pass after aligning factories/schema and fixing audit whitelist.
  - Note: Pest result cache warning persists due to vendor temp permissions.
- Files:
  - tests/Feature/SearchApiTest.php
  - tests/Feature/SearchPageTest.php
  - tests/Feature/SearchSecurityTest.php
  - database/factories/AspirationFactory.php
  - database/factories/AspirationCategoryFactory.php
  - config/audit.php
- Commands:
  - php artisan test --filter Search --testsuite Feature
- Decisions/Risks:
  - Warning: `vendor/pestphp/pest/.temp/test-results` not writable; does not fail tests but hides result caching.
- Next:
  - Fix permissions for `vendor/pestphp/pest/.temp` (or disable Pest result cache) if warning is disruptive.

- Date: 2026-01-04 20:39
- Scope: testing
- Summary:
  - Re-ran search feature tests after adjusting announcement link authorization in search results.
- Files:
  - app/Services/SearchService.php
- Commands:
  - php artisan test --filter Search --testsuite Feature
- Decisions/Risks:
  - Pest result cache warning still appears (vendor temp permissions).
- Next: none

- Date: 2026-01-05 04:30
- Scope: testing
- Summary:
  - Created `ReportsExportScopeTest.php` with 9 test cases:
    - admin_unit cannot inject unit_id → exports own unit only
    - admin_pusat can filter by unit_id
    - super_admin without unit_id exports all
    - Audit log created with correct payload (report_type, unit_id, row_count, format)
    - Feature flag disabled returns 503
    - anggota role denied access (403)
    - bendahara can export own unit
    - Unimplemented type returns 501 with audit
    - Invalid type returns 422
- Files:
  - tests/Feature/ReportsExportScopeTest.php (NEW)
- Commands:
  - php artisan test --filter ReportsExportScopeTest
- Decisions/Risks:
  - Tests cover scope enforcement, audit logging, and role-based access.
- Next: Run tests to verify all pass.

- Date: 2026-01-05 04:50
- Scope: testing
- Summary:
  - R2: Extended `ReportsExportScopeTest.php` with 5 new test cases:
    - aspirations_admin_unit_cannot_inject_unit_id → scope enforcement
    - aspirations_admin_pusat_can_filter_by_unit_id → global filtering
    - aspirations_super_admin_exports_all → no filter = all data
    - aspirations_audit_log_created → audit payload verification
    - members_search_query_hashed_in_audit → q_len/q_hash in payload, no raw q
  - Updated unimplemented_type_returns_501 test to use 'dues' instead of 'aspirations' (now implemented).
- Files:
  - tests/Feature/ReportsExportScopeTest.php
- Commands:
  - php artisan test --filter ReportsExport
- Decisions/Risks:
  - Tests use factory-created Aspiration and AspirationCategory.
- Next: Run tests to verify all pass.

- Date: 2026-01-05 05:25
- Scope: testing
- Summary:
  - R3: Created new test suite `ReportsFinanceExportScopeTest.php` with 7 test cases covering:
    - Scope enforcement (bendahara cannot see other units).
    - Global access (admin_pusat can see any unit).
    - Feature flag (finance disabled = 503).
    - CSV structure validation for `dues_per_period` and `finance_ledgers`.
    - Audit log verification.
    - Calculation logic check for `finance_monthly_summary`.
- Files:
  - tests/Feature/ReportsFinanceExportScopeTest.php
- Commands:
  - php artisan test --filter ReportsFinanceExportScopeTest
- Decisions/Risks:
  - Tests rely on factories; ensure seeding is consistent if running in different envs.
- Next: Run full suite.

- Date: 2026-01-05 05:40
- Scope: testing
- Summary:
  - R4: Export Status Tests.
  - Created `ReportsExportStatusTest` covering:
    - Status lifecycle (idle -> started -> completed/failed).
    - Status endpoint JSON structure.
    - RBAC enforcement (unauthorized user gets 403).
    - Basic integration with Controller.
- Commands:
  - php artisan test --filter ReportsExportStatusTest
- Next: None

- Date: 2026-01-05 09:54
- Scope: testing
- Summary:
  - Created tests/Feature/SettingsSessionsTest.php.
  - Issue: Tests failing silently (empty output) in environment, suspect session driver config or sqlite limitation with raw DB table access vs Laravel session manager.
  - Verification done via detailed code review; logic is standard.
- Files: tests/Feature/SettingsSessionsTest.php
- Next: Investigate test environment output capturing.

- Date: 2026-01-05 09:58
- Scope: testing
- Summary:
  - Created tests/Feature/NotificationPrefsTest.php.
  - Issue: Tests failing silently (empty output) in environment. Suspect environment config.
  - Verification: Manual code review confirms logic.
- Files: tests/Feature/NotificationPrefsTest.php
- Next: Investigate test environment output capturing.

- Date: 2026-01-05 10:38
- Scope: testing
- Summary:
  - Created  to verify role-based visibility of dashboard items.
  - Verifies Super Admin sees cross-unit data.
  - Verifies Admin Unit sees only own-unit data.
- Files: tests/Feature/DashboardScopeTest.php
- Next: none

- Date: 2026-01-07 00:07
- Scope: testing
- Summary:
  - Created `LetterSingleApprovalTest.php` with 2 test cases:
    - single_approval_letter_gets_approved_and_numbered_on_first_approve
    - single_approval_letter_without_secondary_returns_false_for_requires_secondary
  - Created `LetterTwoStepApprovalTest.php` with 6 test cases:
    - two_step_letter_primary_approve_stays_submitted
    - two_step_letter_secondary_approve_makes_final_approved
    - bendahara_cannot_approve_before_primary_approval
    - ketua_cannot_approve_secondary_slot
    - two_step_letter_returns_true_for_requires_secondary
    - helper_methods_reflect_approval_state
  - Added `signer_type_secondary` field to letter form UI (optional bendahara 2nd approver).
- Files:
  - tests/Feature/LetterSingleApprovalTest.php (NEW)
  - tests/Feature/LetterTwoStepApprovalTest.php (NEW)
  - resources/js/Pages/Letters/Form.vue
- Commands:
  - php artisan test tests/Feature/LetterSingleApprovalTest.php
  - php artisan test tests/Feature/LetterTwoStepApprovalTest.php
- Decisions/Risks:
  - Tests verify both single (1x) and dual (2x) approval flows.
  - Bendahara position must exist for two-step tests to pass.
- Next: none

- Date: 2026-01-07 00:16
- Scope: testing
- Summary:
  - L3 Enhanced Testing: Comprehensive test coverage for optional secondary approver per L3 prompt.
  - Created `LetterFactory.php` with states: submitted(), twoStepApproval(), primaryApproved().
  - Enhanced `LetterSingleApprovalTest.php` (5 tests):
    - ketua_can_approve_single_approval_letter_and_finalize
    - bendahara_cannot_approve_single_approval_letter_when_not_matching_signer_type
    - single_approval_letter_returns_false_for_requires_secondary_approval
    - single_approval_sets_approved_at_on_first_approve
    - approved_letter_cannot_be_approved_again
  - Enhanced `LetterTwoStepApprovalTest.php` (8 tests):
    - primary_approval_does_not_finalize_when_secondary_required
    - secondary_approval_finalizes_and_generates_number
    - bendahara_cannot_approve_before_primary_is_done
    - primary_cannot_approve_twice_or_approve_secondary_slot
    - two_step_letter_returns_true_for_requires_secondary_approval
    - helper_methods_reflect_approval_state_transitions
    - fully_approved_two_step_letter_cannot_be_approved_again
  - Created `LetterApprovalsQueueTest.php` (6 tests):
    - ketua_sees_two_step_letter_when_primary_pending
    - bendahara_does_not_see_two_step_letter_when_primary_pending
    - after_primary_approval_ketua_no_longer_sees_letter
    - after_primary_approval_bendahara_sees_letter
    - unit_b_ketua_cannot_see_unit_a_letters
    - fully_approved_letter_not_shown_in_queue
- Files:
  - database/factories/LetterFactory.php (NEW)
  - tests/Feature/LetterSingleApprovalTest.php (ENHANCED)
  - tests/Feature/LetterTwoStepApprovalTest.php (ENHANCED)
  - tests/Feature/LetterApprovalsQueueTest.php (NEW)
- Commands:
  - php artisan test tests/Feature/LetterSingleApprovalTest.php
  - php artisan test tests/Feature/LetterTwoStepApprovalTest.php
  - php artisan test tests/Feature/LetterApprovalsQueueTest.php
- Decisions/Risks:
  - All tests verify 403 for unauthorized approval attempts (no policy bypass).
  - Tests cover full state transitions and queue visibility.
  - No external dependencies or network calls.
- Next: none

- Date: 2026-01-07 09:21
- Scope: testing
- Summary:
  - TE1: Verified Tiptap Rich Text Editor integration.
  - Build succeeded (1230 modules, 3.58s).
  - Manual verification required for `/letters/create`.
- Files:
  - resources/js/Components/UI/RichTextEditor.vue (NEW)
  - resources/js/Pages/Letters/Form.vue
  - resources/css/app.css
- Commands:
  - npm i @tiptap/vue-3 @tiptap/starter-kit @tiptap/extension-underline @tiptap/extension-link @tiptap/extension-text-align
  - npm run build
- Decisions/Risks:
  - No automated UI tests for rich text editor; relies on manual browser testing.
- Next: Manual verification of toolbar buttons, formatting, template apply, and save flow.

- Date: 2026-01-07 09:47
- Scope: testing
- Summary:
  - TE4: Integration tests for letter body sanitization.
  - Created `LetterBodySanitizationTest.php` with 6 test cases (29 assertions).
  - Tests verify: script tag removal, javascript: link sanitization, event handler stripping, list preservation, formatting preservation, safe link attributes.
- Files:
  - tests/Feature/LetterBodySanitizationTest.php (NEW)
- Commands:
  - php artisan test --filter LetterBodySanitizationTest
- Test Results:
  - 6 tests, 29 assertions, OK
- Decisions/Risks:
  - Uses RefreshDatabase trait for isolation.
  - Role::firstOrCreate includes label field for schema compatibility.
- Next: none

